<extend name="Public/common" />
<block name="body">
    <div class="ibox float-e-margins">
        <div class="ibox-title">
            <h5>用户店铺管理</h5>
            <div class="ibox-tools" style="display:none;">
                <a class="collapse-link">
                    <i class="fa fa-chevron-up"></i>
                </a>
                <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                    <i class="fa fa-wrench"></i>
                </a>
                <ul class="dropdown-menu dropdown-user">
                    <li><a href="#">选项1</a>
                    </li>
                    <li><a href="#">选项2</a>
                    </li>
                </ul>
                <a class="close-link">
                    <i class="fa fa-times"></i>
                </a>
            </div>
        </div>
        <div class="ibox-content">
            <div class="row row-lg">
                <div class="col-sm-12">
                    <div id="toolbar">
                        <div style="float: left">
                            <button id="seeinfo" class="btn btn-primary" disabled>
                                查看备注
                            </button>
                        </div>
                        <select name="" class="form-control" id="user_group" style="float: left;width: 140px;margin-left: 20px;">
                            <option value="0">选择属组</option>
                            <foreach name="user_group" item="one_row">
                                <option value="{$one_row.id}" <if condition="$one_row['id'] eq $gid">selected</if> >{$one_row.group_name}</option>
                            </foreach>
                        </select>

                    </div>
                    <table id="table"
                           data-toolbar="#toolbar"
                           data-search="true"
                           data-show-refresh="true"
                           data-show-columns="true"
                           data-show-export="true"
                           data-minimum-count-columns="5"
                           data-pagination="true"
                           data-id-field="id"
                           data-sort-name="id"
                           data-detail-formatter="detailFormatter"
                           data-click-select = true
                           data-order="asc"
                           data-page-size = "10"
                           data-page-number = "1"
                           data-page-list="[10,20,50,100,ALL]"
                           data-show-footer="false"
                           data-side-pagination="server"
                           data-url="/index.php/admin/user/loadShop/gid/{$gid}"
                           data-response-handler="responseHandler">
                    </table>

                </div>
            </div>
        </div>
    </div>
</block>
<block name="modal">
    <div class="modal fade" id="addCustomer" role="dialog">
        <div class="modal-dialog modal-lt">
            <div class="modal-content">

            </div>
        </div>
    </div>
</block>
<block name="script">
    <script type="text/javascript">
        var $table = $('#table'), $seeinfo=$('#seeinfo');selections = [];
        var $EditAuth = $('#EditAuth');
        function initTable() {
            $table.bootstrapTable({
                height: getHeight(),
                clickToSelect:true,
                formatLoadingMessage:function(){
                    return '正在加载，请稍候...';
                },
                formatShowingRows: function (pageFrom, pageTo, totalRows) {
                    return '第 ' + pageFrom + ' - ' + pageTo + ' 记录，共 ' + totalRows + ' 条记录';
                },
                formatRecordsPerPage:function(pageNumber){
                    return '每页 '+pageNumber + ' 记录';
                },
                //queryParams: queryParams, //参数
                columns: [
                    [
                        //{field: 'Number', title: 'Number', formatter: function (value, row, index) {return index + 1;}},
                        {checkbox: true, align: 'center', valign: 'middle'},
                        //{field: 'Sort',title: '排序', align: 'center', valign: 'middle', sortable: true,},
                        //{field: 'id',title: '店铺id', align: 'center'},
                        {field: 'user_name',title: '用户名', align: 'center'},
                        {field: 'mobile',title: '手机号', align: 'center'},
                        {field: 'group_name',title: '属组', align: 'center'},
                        {field: 'shop_name', title: '店铺名', align: 'center'},
                        {field: 'shop_zg', title: '店铺掌柜', align: 'center'},
                        {field: 'forbid', title: '状态', align: 'center'},
                        {field: 'c_date', title: '创建时间', align: 'center'},
                    ]
                ]
            });
            // sometimes footer render error.
            setTimeout(function () {
                $table.bootstrapTable('resetView');
            }, 200);
            $table.on('check.bs.table uncheck.bs.table ' +
                    'check-all.bs.table uncheck-all.bs.table', function () {
                $seeinfo.prop('disabled', !$table.bootstrapTable('getSelections').length);
                var checkLen = $table.bootstrapTable('getSelections').length;
                if(checkLen == 1){
                    //$edit.attr("data-remote",""+getIdSelections()+'&t=' + Math.random(1000) );

                    $seeinfo.prop('disabled',false);
                }else{
                    //$edit.attr("data-remote","javascript:void(0);");

                    $seeinfo.prop('disabled',true);
                }
                selections = getIdSelections();
            });

            $seeinfo.click(function(){
                $("#addCustomer").modal({
                    remote: "/index.php/admin/user/seeinfo?id=" + getIdSelections()+'&t=' + Math.random(1000)
                });
            });

            $(window).resize(function () {
                $table.bootstrapTable('resetView', {
                    height: getHeight()
                });
            });
        }

        function getIdSelections(param) {
            return $.map($table.bootstrapTable('getSelections'), function (row) {
                return row.id;
            });
        }
        //$("#model").on("hidden.bs.model",function(e){$(this).removeData();});
        $(function () {
            $("#addCustomer").on("hidden.bs.modal", function() {
                $(this).removeData("bs.modal");
                $edit.prop('disabled',true);
                $EditAuth.prop('disabled',true);
                $remove.prop('disabled',true);
                $table.bootstrapTable('refresh', {silent: true});
            });
            eachSeries(getScript, initTable);
        });
        $("#user_group").change(function () {
            var gid = $(this).val();
            var url = "__CONTROLLER__/shop/gid/"+gid;
            window.location.href=url;
        });
    </script>
</block>